"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),Keyboard=function(){function t(e){_classCallCheck(this,t),this.code=e,this.isDown=!1,this.isUp=!0,this.press=void 0,this.release=void 0,this.init()}return _createClass(t,[{key:"downHandler",value:function(t){t.keyCode==this.code&&(this.isUp&&this.press&&this.press(),this.isDown=!0,this.isUp=!1),t.preventDefault()}},{key:"upHandler",value:function(t){t.keyCode==this.code&&(this.isDown&&this.release&&this.release(),this.isDown=!1,this.isUp=!0),t.preventDefault()}},{key:"init",value:function(){window.addEventListener("keydown",this.downHandler.bind(this),!1),window.addEventListener("keyup",this.upHandler.bind(this),!1)}}]),t}(),App=function(){function t(){var e=this;_classCallCheck(this,t),this.Container=PIXI.Container,this.autoDetectRenderer=PIXI.autoDetectRenderer,this.loader=PIXI.loader,this.resources=PIXI.loader.resources,this.Sprite=PIXI.Sprite,this.Graphics=PIXI.Graphics,this.BaseTexture=PIXI.BaseTexture,this.Texture=PIXI.Texture,this.Text=PIXI.Text,this.radio=window.innerWidth/640*2,this.bump=new Bump(PIXI),this.su=new SpriteUtilities(PIXI),this.d=new Dust(PIXI),this.wrapSize={x:540,y:808},this.renderer=PIXI.autoDetectRenderer(this.wrapSize.x*this.radio,this.wrapSize.y*this.radio,{antialias:!1,transparent:!0,resolution:1}),this.stage=new PIXI.Container,this.group=new this.Container,this.graphics=new this.Graphics,this.state=null,this.roadStage=null,this.hitTestElement=null,this.walkElement=null,this.roadData={angle:Math.PI/180*-45,len:this.wrapSize.x*this.radio,gap:0,position:{x:0,y:0},roadWidth:200*this.radio},this.speed=1,this.size=function(t){return t*e.radio},this.init()}return _createClass(t,[{key:"init",value:function(){this.mount(),this.load()}},{key:"mount",value:function(){document.querySelector("#app").appendChild(this.renderer.view),this.renderer.view.style.display="block",this.renderer.view.style.width=window.innerWidth+"px",this.renderer.view.style.margin="40px auto",this.renderer.view.style.transform="rotateX(35deg) translateZ(300px)",this.renderer.view.style.transformOrigin="center"}},{key:"play",value:function(){this.bump,this.hitTestElement,this.roadStage,this.speed,this.walkElement,this.size}},{key:"load",value:function(){this.loader.add(["./images/assets/test.json","./images/assets/timg.jpg"]).load(this.setup.bind(this))}},{key:"setup",value:function(){var t=this,e=(this.Sprite,this.stage),i=(this.resources,this.Graphics),s=this.size;this.wrapSize,this.bump;this.roadStage=this.drawRoad();for(var a=15;a;)this.addRoad(),a--;e.addChild(this.roadStage),this.setHitTestElement(),this.setWalkEle(),e.addChild(this.walkElement);for(var n in this.roadStage.children){var r=(this.getPointX({rotation:this.roadStage.children[n].rotation,oriPos:this.roadStage.children[n].getGlobalPosition(),y:this.roadStage.children[n].getGlobalPosition().y,r:this.roadStage.children[n].width/2,type:"left"}),this.getEndY({rotation:this.roadStage.children[n].rotation,oriPos:this.roadStage.children[n].getGlobalPosition(),r:this.roadStage.children[n].height})),o=new i,h=o.beginFill("0xff7777").drawRect(0,0,s(10),s(10)).endFill();h.position.set(0,r),this.stage.addChild(h)}this.state=this.play;!function e(){requestAnimationFrame(e),t.state(),t.renderer.render(t.stage)}()}},{key:"getEndY",value:function(t){var e=t.rotation,i=t.oriPos,s=t.r;return i.y-Math.cos(e)*s}},{key:"getPointX",value:function(t){var e=t.rotation,i=t.oriPos,s=t.y,a=t.r,n=t.type,r=(s-i.y)/Math.tan(Math.PI-e)+i.x;return"left"==n?r-a/Math.cos(e):"right"==n?r+a/Math.cos(e):void 0}},{key:"setWalkEle",value:function(){var t=this.su,e=this.wrapSize,i=this.size,s=(this.roadStage,t.filmstrip("./images/assets/timg.jpg",59,93)),a=t.sprite(s);a.states={down:0,left:4,right:8,up:12,walkDown:[0,3],walkLeft:[4,7],walkRight:[8,11],walkUp:[12,15]},a.show(a.states.left),a.scale.set(3,3),a.animationSpeed=.2,a.fps=8,a.position.set(i(e.x/2)-88.5,1.2*i(e.y/2)),a.loop=!0,a.onComplete=function(){console.log(1)},a.vx=0;var n=new Keyboard(37);n.press=function(){a.playAnimation(a.states.walkLeft),a.vx=-1,a.vy=0,a.cur="left"},n.release=function(){r.isDown||0!=a.vy||(a.vx=0,a.show(a.states.left),a.cur=null)};var r=new Keyboard(39);r.press=function(){a.playAnimation(a.states.walkRight),a.vx=1,a.vy=0,a.cur="right"},r.release=function(){n.isDown||0!=a.vy||(a.vx=0,a.show(a.states.right),a.cur=null)},this.walkElement=a}},{key:"setHitTestElement",value:function(){var t=this.hitTestElement,e=this.Graphics,i=this.stage,s=this.size,a=this.wrapSize;t=(new e).beginFill("0x000000").drawRect(0,0,s(100),s(100)).endFill(),t.position.set(s(a.x/2),2*s(a.y)),i.addChild(t)}},{key:"drawRoad",value:function(){var t=(this.Sprite,this.stage,this.resources,this.Graphics,this.size),e=this.wrapSize,i=this.Container,s=new i;return s.width=t(e.x),s.height=t(e.y/2),s.pivot.set(t(e.x/2),0),s.rotation=Math.PI,s.position.set(t(e.x/2),t(e.y)),s}},{key:"addRoad",value:function(){var t=this.Graphics,e=this.roadStage,i=this.size,s=this.roadData,a=s.angle,n=s.len,r=s.position,o=s.roadWidth,h=(s.gap,new t);h.beginFill("0x0f5ff0").drawRect(i(-100),-o/2,o,n).endFill(),h.rotation=a,h.position.set(r.x,r.y),e.addChild(h),this.roadData.position=this.getPositionFromAngle(r,a,n),this.roadData.angle*=-1,this.roadData.len=Math.random()*(i(this.wrapSize.x)-i(.4*this.wrapSize.x))+i(.4*this.wrapSize.x)}},{key:"getPositionFromAngle",value:function(t,e,i){var s={x:t.x,y:t.y+i};return{x:(s.x-t.x)*Math.cos(e)-(s.y-t.y)*Math.sin(e)+t.x,y:(s.x-t.x)*Math.sin(e)+(s.y-t.y)*Math.cos(e)+t.y}}}]),t}();window.onload=function(){new App};